<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.mappers.adminOrderMapper">
	
	<!-- 카드 취소 조회 (조회) -->
	<select id="selectCardCancelByInfo" resultType="CardCancelResponse">
		SELECT 	 	p.payment_time,
					c.request_time,
				 	d.product_order_no,
				 	p.order_no,
		         	m.name,
		         	h.member_id,
		         	p.payment_number,
		         	c.amount,
		         	c.processing_status,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		INNER JOIN  cancellations c
		On			d.detailed_order_id = c.detailed_order_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			(p.card_number != "" and p.card_number is not null)
			AND p.payment_status REGEXP '취소|환불'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(requestTimeStart != null and !requestTimeStart.equals("")) and 
	         		(requestTimeEnd != null and !requestTimeEnd.equals(""))'>
	         		AND c.request_time BETWEEN #{requestTimeStart} AND #{requestTimeEnd}
         	</if>
         	<if test='(completionTimeStart != null and !completionTimeStart.equals("")) and 
	         		(completionTimeEnd != null and !completionTimeEnd.equals(""))'>
	         		AND c.completion_time BETWEEN #{completionTime} AND #{completionTime}
         	</if>
         	<choose>
				<when test='status == 0'>
					AND c.processing_status = '취소접수' AND (c.completion_time is null or c.completion_time = '')
				</when>
				<when test='status == 1'>
					AND c.processing_status = '취소완료' AND (c.completion_time is not null and c.completion_time != '')
				</when>
			</choose>	
		</where>
		ORDER BY c.request_time DESC
	</select>
	
	<!-- 환불 관리 (조회)  -->
	<select id="selectRefundByInfo" resultType="RefundResponse">
		SELECT 	 	h.order_time,
					f.refund_application_date,
					f.refund_processing_completion_date,
				 	d.product_order_no,
				 	p.order_no,
		         	f.refunds_id,
		         	m.name,
		         	h.member_id,
		         	d.product_quantity,
		         	f.total_refund_amount,
		         	f.actual_refund_amount,
		         	f.refund_reward_used,
		         	f.refund_point_used,
		         	p.payment_method,
		         	f.refund_processing_detail,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		INNER JOIN  returns r
		On			d.detailed_order_id = r.detailed_order_id
		INNER JOIN  cancellations c
		On			d.detailed_order_id = c.detailed_order_id
		INNER JOIN  refunds f
		On			r.return_id = f.return_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			f.refund_processing_detail REGEXP '환불'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(requestTimeStart != null and !requestTimeStart.equals("")) and 
	         		(requestTimeEnd != null and !requestTimeEnd.equals(""))'>
	         		AND f.refund_application_date BETWEEN #{requestTimeStart} AND #{requestTimeEnd}
         	</if>
         	<if test='(completionTimeStart != null and !completionTimeStart.equals("")) and 
	         		(completionTimeEnd != null and !completionTimeEnd.equals(""))'>
	         		AND f.refund_processing_completion_date BETWEEN #{completionTime} AND #{completionTime}
         	</if>
         	<choose>
				<when test='status == 0'>
					AND f.refund_processing_detail = '환불전' AND (f.refund_processing_completion_date is null or f.refund_processing_completion_date = '')
				</when>
				<when test='status == 1'>
					AND f.refund_processing_detail = '환불완료' AND (f.refund_processing_completion_date is not null and f.refund_processing_completion_date != '')
				</when>
			</choose>	
		</where>
		ORDER BY f.refund_application_date DESC, d.product_order_no DESC
	</select>
	
	<!-- 반품 관리 (조회)  -->
	<select id="selectReturnByInfo" resultType="ReturnResponse">
		SELECT 	 	r.request_time,
				 	d.product_order_no,
				 	p.order_no,
		         	r.returns_id,
		         	m.name,
		         	h.member_id,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	d.product_invoice_number,
		         	r.processing_status,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		INNER JOIN  returns r
		On			d.detailed_order_id = r.detailed_order_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			r.processing_status REGEXP '반품|반송|교환|환불'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(requestTimeStart != null and !requestTimeStart.equals("")) and 
	         		(requestTimeEnd != null and !requestTimeEnd.equals(""))'>
	         		AND r.request_time BETWEEN #{requestTimeStart} AND #{requestTimeEnd}
         	</if>
         	<if test='(completionTimeStart != null and !completionTimeStart.equals("")) and 
	         		(completionTimeEnd != null and !completionTimeEnd.equals(""))'>
	         		AND r.completion_time BETWEEN #{completionTime} AND #{completionTime}
         	</if>
         	<choose>
				<when test='status == 0'>
					AND r.processing_status REGEXP '신청|반송' AND (r.completion_time is null or r.completion_time = '')
				</when>
				<when test='status == 1'>
					AND r.processing_status REGEXP '완료|교환|환불' AND (r.completion_time is not null and r.completion_time != '')
				</when>
			</choose>	
		</where>
		ORDER BY r.request_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 교환 관리 (조회) -->
	<select id="selectExchangeByInfo" resultType="ExchangeResponse">
		SELECT 	 	e.request_time,
				 	d.product_order_no,
				 	p.order_no,
		         	e.exchanges_id,
		         	m.name,
		         	h.member_id,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	e.processing_status,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		INNER JOIN  returns r
		On			d.detailed_order_id = r.detailed_order_id
		INNER JOIN  exchanges e
		On			r.returns_id = e.returns_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			e.processing_status REGEXP '교환'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(requestTimeStart != null and !requestTimeStart.equals("")) and 
	         		(requestTimeEnd != null and !requestTimeEnd.equals(""))'>
	         		AND e.request_time BETWEEN #{requestTimeStart} AND #{requestTimeEnd}
         	</if>
         	<if test='(completionTimeStart != null and !completionTimeStart.equals("")) and 
	         		(completionTimeEnd != null and !completionTimeEnd.equals(""))'>
	         		AND e.completion_time BETWEEN #{completionTime} AND #{completionTime}
         	</if>
         	<choose>
				<when test='status == 0'>
					AND e.processing_status = '교환중' AND (e.completion_time is null or e.completion_time = '')
				</when>
				<when test='status == 1'>
					AND e.processing_status = '교환완료' AND (e.completion_time is not null and e.completion_time != '')
				</when>
			</choose>	
		</where>
		ORDER BY e.request_time DESC
	</select>
	
	<!-- 취소 관리 (조회) -->
	<select id="selectCancelByInfo" resultType="CancelResponse">
		SELECT 	 	c.request_time,
				 	d.product_order_no,
				 	p.order_no,
		         	c.cancel_id,
		         	m.name,
		         	h.member_id,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	c.amount,
		         	p.payment_method,
		         	c.reason,
		         	c.processing_status,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		INNER JOIN  cancellations c
		On			d.detailed_order_id = c.detailed_order_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			(b.deposit_amount != 0 and b.deposit_amount is not null)
			AND h.delivery_status != '입금전'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(requestTimeStart != null and !requestTimeStart.equals("")) and 
	         		(requestTimeEnd != null and !requestTimeEnd.equals(""))'>
	         		AND c.request_time BETWEEN #{requestTimeStart} AND #{requestTimeEnd}
         	</if>
         	<if test='(completionTimeStart != null and !completionTimeStart.equals("")) and 
	         		(completionTimeEnd != null and !completionTimeEnd.equals(""))'>
	         		AND c.completion_time BETWEEN #{completionTime} AND #{completionTime}
         	</if>
         	<choose>
				<when test='status == 0'>
					AND c.processing_status = '취소접수' AND (c.completion_time is null or c.completion_time = '')
				</when>
				<when test='status == 1'>
					AND c.processing_status = '취소완료' AND (c.completion_time is not null and c.completion_time != '')
				</when>
			</choose>	
		</where>
		ORDER BY c.request_time DESC
	</select>

	<!-- 입금 전 취소 관리 (조회) -->
	<select id="selectPendingCancelByInfo" resultType="PendingCancelResponse">
		SELECT 	 	c.request_time,
				 	p.order_no,
		         	m.name,
		         	h.member_id,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	d.product_price,
		         	b.amount_to_pay,
		         	p.payment_method,
		         	c.reason,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		INNER JOIN  cancellations c
		On			d.detailed_order_id = c.detailed_order_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
		</where>
		ORDER BY c.request_time DESC, d.product_order_no DESC
	</select>

	<!-- 배송 완료 조회 (조회[상품별]) -->
	<select id="selectDeliveredProductInfo" resultType="DeliveredProductResponse">
		SELECT 	 	i.product_image,
				 	p.order_no,
		         	pr.category_key,
                 	pr.publisher,
		         	pr.product_name,
		         	pr.product_id,
                 	pr.supply_price,
		         	d.product_quantity,
		         	pr.current_quantity
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN 	bank_transfers b 
		ON 			p.payment_number = b.payment_number
		Left JOIN 	(
						SELECT product_id, 
							   product_image
			            FROM product_images
			            GROUP BY product_id
			        ) i
		ON 			pr.product_id = i.product_id
		<where> 
			d.product_status = '배송완료'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 배송 완료 조회 (조회[품목 주문번호별]) -->
	<select id="selectDeliveredProductNoInfo" resultType="DeliveredProductNoResponse">
		SELECT 	 	h.order_time,
					d.product_order_no,
		         	m.name,
		         	h.member_id,
                 	d.product_invoice_number,
                 	d.invoice_input_date,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			d.product_status = '배송완료'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 배송 완료 조회 (조회[주문번호별]) -->
	<select id="selectDeliveredNoInfo" resultType="DeliveredNoResponse">
		SELECT 	 	h.order_time,
				 	h.order_no,
		         	m.name,
		         	h.member_id,
		         	d.product_order_no,
                 	d.product_invoice_number,
                 	d.invoice_input_date,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			d.product_status = '배송완료'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 배송 중 관리 (배송완료 처리[배송중 -> 배송완료] orderNO) -->
	<update id="updateDeliveredByNo">
		UPDATE 		order_history h 
		INNER JOIN  payments p
		ON 			h.order_no = p.order_no
		INNER JOIN  detailed_order_items d
		ON 			h.order_no = d.order_no
		SET 		h.delivery_status = 
						CASE WHEN h.delivery_status = '배송중' 
							 THEN '배송완료' 
							 ELSE h.delivery_status 
						END,
					d.product_status = 
						CASE WHEN d.product_status = '배송중' 
							 THEN '배송완료' 
							 ELSE d.product_status 
						END,
		            p.payment_status = 
	            		CASE WHEN p.payment_status = '배송중' 
	            			 THEN '배송완료' 
	            			 ELSE p.payment_status 
            			END
		WHERE		d.product_invoice_number is not null AND 
					d.order_no IN 
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
						#{orderNo}
					</foreach>
	</update>
	
	<!-- 배송 중 관리 (배송완료 처리[배송중 -> 배송완료] ProductOrderNo) -->
	<update id="updateDeliveredByProductNo">
		UPDATE 		order_history h 
		INNER JOIN  payments p
		ON 			h.order_no = p.order_no
		INNER JOIN  detailed_order_items d
		ON 			h.order_no = d.order_no
		SET 		h.delivery_status = 
						CASE WHEN h.delivery_status = '배송중' 
							 THEN '배송완료' 
							 ELSE h.delivery_status 
						END,
					d.product_status = 
						CASE WHEN d.product_status = '배송중' 
							 THEN '배송완료' 
							 ELSE d.product_status 
						END,
		            p.payment_status = 
	            		CASE WHEN p.payment_status = '배송중' 
	            			 THEN '배송완료' 
	            			 ELSE p.payment_status 
            			END
		WHERE		d.product_invoice_number is not null AND 
					d.product_order_no IN 
					<foreach collection="list" item="productOrderNo" open="(" close=")" separator=",">
						#{productOrderNo}
					</foreach>
	</update>
	
	<!-- 배송 중 관리 (조회[상품별]) -->
	<select id="selectInTransitProductInfo" resultType="InTransitProductResponse">
		SELECT 	 	i.product_image,
				 	p.order_no,
		         	pr.category_key,
                 	pr.publisher,
		         	pr.product_name,
		         	pr.product_id,
                 	pr.supply_price,
		         	d.product_quantity,
		         	pr.current_quantity
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN 	bank_transfers b 
		ON 			p.payment_number = b.payment_number
		Left JOIN 	(
						SELECT product_id, 
							   product_image
			            FROM product_images
			            GROUP BY product_id
			        ) i
		ON 			pr.product_id = i.product_id
		<where> 
			d.product_status = '배송중'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 배송 중 관리 (조회[품목 주문번호별])  -->
	<select id="selectInTransitProductNoInfo" resultType="InTransitProductNoResponse">
		SELECT 	 	h.order_time,
					d.product_order_no,
		         	m.name,
		         	h.member_id,
                 	d.product_invoice_number,
                 	d.invoice_input_date,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			d.product_status = '배송중'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 배송 중 관리 (조회[주문번호별]) -->
	<select id="selectInTransitNoInfo" resultType="InTransitNoResponse">
		SELECT 	 	h.order_time,
				 	h.order_no,
		         	m.name,
		         	h.member_id,
		         	d.product_order_no,
                 	d.product_invoice_number,
                 	d.invoice_input_date,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			d.product_status = '배송중'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 배송 준비중 관리 (배송중 처리) orderNo-->
	<update id="updateInTransitByNo">
		UPDATE 		order_history h 
		INNER JOIN  payments p
		ON 			h.order_no = p.order_no
		INNER JOIN  detailed_order_items d
		ON 			h.order_no = d.order_no
		SET 		h.delivery_status = 
						CASE WHEN h.delivery_status = '출고완료' 
							 THEN '배송중' 
							 ELSE h.delivery_status 
						END,
					d.product_status = 
						CASE WHEN d.product_status = '출고완료' 
							 THEN '배송중' 
							 ELSE d.product_status 
						END,
		            p.payment_status = 
	            		CASE WHEN p.payment_status = '출고완료' 
	            			 THEN '배송중' 
	            			 ELSE p.payment_status 
            			END
		WHERE		d.product_invoice_number is not null AND 
					d.order_no IN 
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
						#{orderNo}
					</foreach>
	</update>
	
	<!-- 배송 준비중 관리 (배송중 처리) ProductOrderNo-->
	<update id="updateInTransitByProductNo">
		UPDATE 		order_history h 
		INNER JOIN  payments p
		ON 			h.order_no = p.order_no
		INNER JOIN  detailed_order_items d
		ON 			h.order_no = d.order_no
		SET 		h.delivery_status = 
						CASE WHEN h.delivery_status = '출고완료' 
							 THEN '배송중' 
							 ELSE h.delivery_status 
						END,
					d.product_status = 
						CASE WHEN d.product_status = '출고완료' 
							 THEN '배송중' 
							 ELSE d.product_status 
						END,
		            p.payment_status = 
	            		CASE WHEN p.payment_status = '출고완료' 
	            			 THEN '배송중' 
	            			 ELSE p.payment_status 
            			END
		WHERE		d.product_invoice_number is not null AND 
					d.product_order_no IN 
					<foreach collection="list" item="productOrderNo" open="(" close=")" separator=",">
						#{productOrderNo}
					</foreach>
	</update>
	
	<!-- 배송 준비중 관리 (출고 완료 처리) orderNo-->
	<update id="updateShippedByNo">
		UPDATE 		order_history h 
		INNER JOIN  payments p
		ON 			h.order_no = p.order_no
		INNER JOIN  detailed_order_items d
		ON 			h.order_no = d.order_no
		SET 		h.delivery_status = 
						CASE WHEN h.delivery_status = '결제완료' or h.delivery_status = '배송중'
							 THEN '출고완료' 
							 ELSE h.delivery_status 
						END,
					d.product_status = 
						CASE WHEN d.product_status = '결제완료' or d.product_status = '배송중'
							 THEN '출고완료' 
							 ELSE d.product_status 
						END,
		            p.payment_status = 
	            		CASE WHEN p.payment_status = '결제완료' or p.payment_status = '배송중'
	            			 THEN '출고완료' 
	            			 ELSE p.payment_status 
            			END
		WHERE		d.order_no IN 
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
						#{orderNo}
					</foreach>
	</update>
	
	<!-- 배송 준비중 관리 (출고 완료 처리) ProductOrderNo-->
	<update id="updateShippedByProductNo">
		UPDATE 		order_history h 
		INNER JOIN  payments p
		ON 			h.order_no = p.order_no
		INNER JOIN  detailed_order_items d
		ON 			h.order_no = d.order_no
		SET 		h.delivery_status = 
						CASE WHEN h.delivery_status = '결제완료' or h.delivery_status = '배송중'
							 THEN '출고완료' 
							 ELSE h.delivery_status 
						END,
					d.product_status = 
						CASE WHEN d.product_status = '결제완료' or d.product_status = '배송중'
							 THEN '출고완료' 
							 ELSE d.product_status 
						END,
		            p.payment_status = 
	            		CASE WHEN p.payment_status = '결제완료' or p.payment_status = '배송중'
	            			 THEN '출고완료' 
	            			 ELSE p.payment_status 
            			END
		WHERE		d.product_order_no IN 
					<foreach collection="list" item="productOrderNo" open="(" close=")" separator=",">
						#{productOrderNo}
					</foreach>
	</update>
	
	<!-- 배송 준비중 관리 (상품 송장번호 저장) -->
	<update id="updateInvoiceProduct" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";">
			UPDATE detailed_order_items 
			SET    product_invoice_number = #{item.productInvoiceNumber} 
			WHERE  product_order_no = #{item.productOrderNo}
		</foreach>
	</update>
	
	<!-- 배송 준비중 관리 (주문내역 송장번호 저장) -->
	<update id="updateInvoiceHistory">
		UPDATE order_history
		SET    invoice_number = #{productInvoiceNumber}
		WHERE  order_no = #{orderNo} AND invoice_number IS NULL 	
	</update>
	
	<!-- 배송 준비중 관리 (조회[상품별]) -->
	<select id="selectPreparationProductInfo" resultType="PreparationProductResponse">
		SELECT 	 	i.product_image,
				 	p.order_no,
		         	pr.category_key,
                 	pr.publisher,
		         	pr.product_name,
		         	pr.product_id,
                 	pr.supply_price,
		         	d.product_quantity,
		         	pr.current_quantity
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN 	bank_transfers b 
		ON 			p.payment_number = b.payment_number
		Left JOIN 	(
						SELECT product_id, 
							   product_image
			            FROM product_images
			            GROUP BY product_id
			        ) i
		ON 			pr.product_id = i.product_id
		<where> 
			d.product_status = '결제완료' or d.product_status = '출고완료'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 배송 준비중 관리 (조회[주문번호별]) -->
	<select id="selectPreparationNoInfo" resultType="PreparationNoResponse">
		SELECT 	 	h.order_time,
				 	p.payment_time,
				 	p.order_no,
		         	m.name,
		         	h.member_id,
		         	d.product_status,
		         	d.product_order_no,
                 	d.product_invoice_number,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	d.product_price,
		         	p.actual_payment_amount,
		         	p.payment_method,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN  bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			d.product_status = '결제완료' or d.product_status = '출고완료'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
<!-- 주문 상세 정보 (결제 완료 상태 이후 주문 취소 - 품목번호별) -->
	
	<!-- 환불 처리 -->
	<insert id="insertProductCancelRefund">
	
	</insert>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 적립금 로그 테이블 update(column : reason, balance, reward)) -->
	<update id="updateProductCancelReward" parameterType="java.util.List">
			UPDATE		 reward_logs r
			INNER JOIN	 payments p
			ON 			 r.related_order = p.order_no
			INNER JOIN   detailed_order_items d
			ON			 p.order_no = d.order_no
			INNER JOIN   member m
			ON 			 r.member_id = m.member_id
			SET 	 	 r.reason = '주문취소',
						 r.reward = 
							CASE 
							<foreach collection="list" item="item" >
						 		 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) >= p.used_reward
				 				 THEN p.used_reward
				 				 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) < p.used_reward ]]>
				 				 THEN ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}))
	 				  	    </foreach>
				 			END,
			 			 r.balance = 
			 			 	CASE 
			 			 	<foreach collection="list" item="item" >
		 			 			 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) >= p.used_reward
				                 THEN m.total_rewards + p.used_reward
				                 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) < p.used_reward ]]>
				                 THEN m.total_rewards + ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}))
				            </foreach>
				            END,
			 			 p.used_reward =
			 				CASE 
			 				<foreach collection="list" item="item" >
			 				     WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) >= p.used_reward
	                             THEN 0
	                             WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) < p.used_reward ]]>
	                             THEN p.used_reward - ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}))
	                        </foreach>
	                        END,
                         m.total_rewards = m.total_rewards + p.used_reward,
                         m.accumulated_use_reward = m.accumulated_use_reward - p.used_points
			WHERE 		 r.reason != '주문취소' AND 
						 p.payment_status = '결제완료' AND 
						 p.used_reward > 0 AND 
						 d.product_order_no IN
						 <foreach collection="list" item="item" open="(" close=")" separator=",">
						  	#{item.productOrderNo}
						 </foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 포인트 로그 테이블 update(column : reason, balance, point)) -->
	<update id="updateProductCancelPoint" parameterType="java.util.List">
			UPDATE		 point_logs l
			INNER JOIN	 payments p
			ON 			 l.related_order = p.order_no
			INNER JOIN   detailed_order_items d
			ON			 p.order_no = d.order_no
			INNER JOIN   member m
			ON 			 l.member_id = m.member_id
			INNER JOIN   reward_logs r
			ON			 l.related_order = r.related_order
			SET 	 	 l.reason = '주문취소',
						 l.point = 
							CASE 
							<foreach collection="list" item="item" >
						 		 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) >= p.used_points
				 				 THEN p.used_points
				 				 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) < p.used_points ]]>
				 				 THEN ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward)
	 				  	    </foreach>
				 			END,
			 			 r.balance = 
			 			 	CASE 
			 			 	<foreach collection="list" item="item" >
		 			 			 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) >= p.used_points
				                 THEN m.total_points + p.used_points
				                 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) < p.used_points ]]>
				                 THEN m.total_points + ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward)
				            </foreach>
				            END,
			 			 p.used_points =
			 				CASE 
			 				<foreach collection="list" item="item" >
			 				     WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) >= p.used_points
	                             THEN 0
	                             WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) < p.used_points ]]>
	                             THEN p.used_points - ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward)
	                        </foreach>
	                        END,
                         m.total_points = m.total_points + p.used_points,
                         m.accumulated_use_point = m.accumulated_use_point - p.used_points
			WHERE 		 l.reason != '주문취소' AND 
						 r.reason = '주문취소' AND
						 p.payment_status = '결제완료' AND 
						 p.used_points > 0 AND 
						 d.product_order_no IN
						 <foreach collection="list" item="item" open="(" close=")" separator=",">
						  	#{item.productOrderNo}
						 </foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 주문 상세 상품 테이블 update(column : product_status, coupon_discount)) -->
	<update id="updateProductCancel" parameterType="java.util.List">
	        UPDATE  detailed_order_items 
	        SET 	product_status = '주문취소', coupon_discount = 0
	        WHERE   product_status = '결제완료' AND product_order_no IN
			        <foreach collection="list" item="productOrderNo" open="(" close=")" separator=",">
		        		#{productOrderNo}
		    		</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 주문 내역 테이블 update(column : delivery_status)) -->
	<update id="updateProductCancelHistory" parameterType="java.util.List">
			UPDATE 		order_history h
			LEFT JOIN 	(
							SELECT  count(detailed_order_id) count, order_no
							FROM    detailed_order_items 
							WHERE   product_status = '입금전' AND order_no IN 
									<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
										#{orderNo} 
									</foreach>
						) d
			ON 			h.order_no = d.order_no
			SET    		h.delivery_status = if(COALESCE(d.count, 0) = 0 ,'주문취소', '부분취소') 
			WHERE  		h.order_no IN 
						<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
							#{orderNo}
						</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 쿠폰 로그 테이블 update(돌려줄 쿠폰(count:0) select) -->
	<resultMap id="productCouponsResultMap" type="CheckedCoupons">
	    <id column="related_order" property="orderNo"/>
	    <collection property="coupons" resultMap="productCouponCountResultMap"/>
	</resultMap>
	
	<resultMap id="productCouponCountResultMap" type="CouponCount">
	    <result column="coupon_number" property="couponNumber"/>
	    <result column="count" property="count"/>
	</resultMap>
	
	<select id="selectProductCancelCoupon" parameterType="java.util.List" resultMap="productCouponsResultMap">
		<foreach collection="list" item="orderNo" separator="UNION">
	        SELECT		log.coupon_number,
			            COALESCE(ssq.count, 0) count,
			            log.related_order
			FROM		coupon_logs log
			LEFT JOIN (
			                SELECT		cc.coupon_number,
										count(cc.coupon_number) count
			                FROM		coupon_categories cc
			                INNER JOIN (
											SELECT		d.order_no,
														d.product_order_no,
														p.category_key
											FROM		detailed_order_items d
											INNER JOIN 	products p 
			                                ON 			d.product_id = p.product_id
											WHERE		d.product_status REGEXP '입금전|결제완료' AND d.order_no = #{orderNo}
										) s 
							ON 			s.category_key = cc.category_key
			                INNER JOIN (
											SELECT		coupon_number
											FROM		coupon_logs
											WHERE		used_date IS NOT NULL AND related_order = #{orderNo}
											GROUP BY	coupon_number
										) sq 
							ON 			cc.coupon_number = sq.coupon_number
			                WHERE		cc.category_key = s.category_key
			                GROUP BY	cc.coupon_number
			            ) ssq 
			ON 			log.coupon_number = ssq.coupon_number
			WHERE		log.related_order = #{orderNo}
			GROUP BY	coupon_number
    	</foreach>
	</select>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 쿠폰 로그 테이블 update(column : used_date, related_order)) -->
	<update id="updateProductCancelCoupon" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";">
	        UPDATE  coupon_logs
	        SET 	used_date = NULL, related_order = NULL
	        WHERE   related_order = #{item.orderNo}
			        AND (
				            <foreach collection="item.coupons" item="coupon" index="couponIndex" separator=" OR ">
				                (coupon_number = #{coupon.couponNumber} AND #{coupon.count} = 0)
				            </foreach>
			        	)
	    </foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 회원 테이블 update(column : coupon_count, total_points, 
	  							total_rewards, accumulated_use_reward,accumulated_use_point)) -->
	<update id="updateProductCancelMember" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";">
			UPDATE		 member m
			INNER JOIN	 order_history o
			ON  		 m.member_id = o.member_id
			SET 		 m.coupon_count = m.coupon_count + #{item.couponCount}
			WHERE 		 o.order_no = #{item.orderNo}
		</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 결제 테이블 update(column : payment_status)) -->
	<update id="updateProductCancelPayments" parameterType="java.util.List"> 
			UPDATE 		payments p
			INNER JOIN  order_history o
			ON 			p.order_no = o.order_no
			INNER JOIN 	detailed_order_items d
			ON 			p.order_no = d.order_no
			SET 		p.payment_status = o.delivery_status,
						p.total_amount = 
						<foreach collection="list" item="item">
							p.total_amount - (d.product_price * #{item.quantity})	
						</foreach>,	
						p.shipping_fee = 
							CASE 
							<foreach collection="list" item="item">
								 WHEN p.total_amount >= 10000
	                             THEN 0
	                             WHEN <![CDATA[p.total_amount < 10000]]>
	                             THEN 3000
							</foreach>	
	                        END					
			WHERE 		d.product_order_no IN
						<foreach collection="list" item="item" open="(" close=")" separator=",">
				        	#{item.productOrderNo}
				    	</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 취소용 추가 정보 조회) -->
	<select id="selectProductCancelInfo" resultType="PendingCancelInfoResponse">
		SELECT  detailed_order_id, product_id, product_order_no 
		FROM    detailed_order_items
		WHERE   product_status = '주문취소' AND order_no IN
				<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
		        	#{orderNo}
		    	</foreach>
	</select>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[품목주문별] - 취소 테이블에 추가) -->
	<insert id="insertProductCancel" parameterType="java.util.List">
			INSERT INTO cancellations(product_id, reason, amount, processing_status, 
									  refund_status, request_time, completion_time, detailed_order_id) 
            VALUES	
           	<foreach collection="list" item="item" separator=",">
            (		
            	#{item.productId}, 
            	'주문취소[관리자]', 
            	(SELECT (product_price * product_quantity) amount FROM detailed_order_items WHERE product_order_no = #{item.productOrderNo}), 
            	'취소완료',
            	'Y',
            	NOW(),
            	NOW(),
            	#{item.detailedOrderId}
            )	
			</foreach>
	</insert>

<!-- 주문 상세 정보 (결제 완료 상태 이후 주문 취소 - 주문번호별) -->
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 적립금 로그 테이블 update(column : reason, balance, reward)) -->
	<update id="updateOrderCancelReward" parameterType="java.util.List">			
			UPDATE		 reward_logs r
			INNER JOIN	 payments p
			ON 			 r.related_order = p.order_no
			INNER JOIN   member m
			ON 			 r.member_id = m.member_id
			SET 		 r.reason = '주문취소', 
						 r.reward = p.used_reward,
			             r.balance = total_rewards + p.used_reward
			WHERE 		 r.reason != '주문취소' AND  
						 p.payment_status = '결제완료' AND 
						 r.related_order IN
						<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
						 	#{orderNo} 
						</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 포인트 로그 테이블 update(column : reason, balance, point)) -->
	<update id="updateOrderCancelPoint" parameterType="java.util.List">
			UPDATE		 point_logs l
			INNER JOIN	 payments p
			ON 			 l.related_order = p.order_no
			INNER JOIN   member m
			ON 			 l.member_id = m.member_id
			SET 		 l.reason = '주문취소', 
						 l.point = p.used_points,
			             l.balance = m.total_points + p.used_points
			WHERE 		 l.reason != '주문취소' AND 
						 p.payment_status = '결제완료' AND 
						 l.related_order IN 
						<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
							#{orderNo}
						</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 주문 상세 상품 테이블 update(column : product_status, coupon_discount)) -->
	<update id="updateOrderCancel" parameterType="java.util.List">
	         UPDATE  detailed_order_items 
	        SET 	product_status = '주문취소', coupon_discount = 0
	        WHERE 	product_status = '결제완료' AND order_no IN
			        <foreach collection="list" item="orderNo" open="(" close=")" separator=",">
		        		#{orderNo}
		    		</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 주문 내역 테이블 update(column : delivery_status)) -->
	<update id="updateOrderCancelHistory" parameterType="java.util.List">
			UPDATE order_history
			SET    delivery_status = '주문취소' 
			WHERE  delivery_status = '결제완료' AND order_no IN
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
			        	#{orderNo}
			    	</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 쿠폰 로그 테이블 update(column : used_date, related_order)) -->
	<update id="updateOrderCancelCoupon" parameterType="java.util.List">
			UPDATE  coupon_logs
			SET     used_date = NULL,related_order = NULL
			WHERE   related_order IN
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
			        	#{orderNo}
			    	</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 회원 테이블 update(column : coupon_count, total_points, 
	 							total_rewards, accumulated_use_reward,accumulated_use_point)) -->
	<update id="updateOrderCancelMember" parameterType="java.util.List">
		<foreach collection="list" item="orderNo" separator=";">
			UPDATE		 member m
			INNER JOIN	 order_history o
			ON  		 m.member_id = o.member_id
			INNER JOIN	 payments p
			ON 			 o.order_no = p.order_no
			LEFT JOIN    (
							SELECT COUNT(detailed_order_id) count, order_no
						  	FROM   detailed_order_items
						  	WHERE  order_no = #{orderNo} AND 
								   (coupon_discount is not null AND coupon_discount != 0)
					     ) s
			ON           o.order_no = s.order_no
			SET 		 m.coupon_count = m.coupon_count + COALESCE(s.count, 0),
						 m.total_points = m.total_points + p.used_points,
			             m.total_rewards = m.total_rewards + p.used_reward,
			             m.accumulated_use_reward = m.accumulated_use_reward - p.used_points,
			             m.accumulated_use_point = m.accumulated_use_point - p.used_reward
			WHERE 		 o.order_no = #{orderNo}
		</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 결제 테이블 update(column : payment_status)) -->
	<update id="updateOrderCancelPayments" parameterType="java.util.List">
			UPDATE  payments
			SET     payment_status = '주문취소', 
				    used_points = 0,
				    used_reward = 0,
				    total_amount = 0,
				    shipping_fee = 0
			WHERE   payment_status = '결제완료' AND order_no IN
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
			        	#{orderNo}
			    	</foreach>
	</update>
	
	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 취소용 추가 정보 조회) -->
	<select id="selectCancelInfo" resultType="PendingCancelInfoResponse">
		SELECT  detailed_order_id, product_id, product_order_no 
		FROM    detailed_order_items
		WHERE   product_status = '주문취소' AND order_no IN
				<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
		        	#{orderNo}
		    	</foreach>
	</select>

	<!-- 주문 상세 정보 (주문 취소 버튼[주문번호별] - 취소 테이블에 추가) -->
	<insert id="insertOrderCancel" parameterType="java.util.List">
			INSERT INTO cancellations(product_id, reason, amount, processing_status, 
									  refund_status, request_time, completion_time, detailed_order_id) 
            VALUES	
           	<foreach collection="list" item="item" separator=",">
            (		
            	#{item.productId}, 
            	'주문취소[관리자]', 
            	(SELECT (product_price * product_quantity) amount FROM detailed_order_items WHERE product_order_no = #{item.productOrderNo}), 
            	'취소완료',
            	'Y',
            	NOW(),
            	NOW(),
            	#{item.detailedOrderId}
            )	
			</foreach>
	</insert>

	<!-- 주문 상세 정보 (상태 확인) -->
	<select id="selectOrdersStatus" resultType="OrderStatus">
		SELECT  <foreach collection="list" item="item">
					<choose>
						<when test="item.productOrderNo == null">
							order_no,
						</when>
						<when test="item.orderNo == null">
							product_order_no,
						</when>
					</choose>					
				</foreach> 
				product_status
		FROM 	detailed_order_items
		WHERE 	product_order_no IN 
				<foreach collection="list" item="item" open="(" close=")" separator=",">
				  	#{item.productOrderNo}
				</foreach>
				or order_no IN 
				<foreach collection="list" item="item" open="(" close=")" separator=",">
				  	#{item.orderNo}
				</foreach>
	</select>
	
<!-- 입금전 주문취소 품목주문별 -->
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 적립금 로그 테이블 update(column : reason, balance, reward)) -->
	<update id="updatePendingProductCancelReward" parameterType="java.util.List">
			UPDATE		 reward_logs r
			INNER JOIN	 payments p
			ON 			 r.related_order = p.order_no
			INNER JOIN   detailed_order_items d
			ON			 p.order_no = d.order_no
			INNER JOIN   member m
			ON 			 r.member_id = m.member_id
			SET 	 	 r.reason = '주문취소',
						 r.reward = 
							CASE 
							<foreach collection="list" item="item" >
						 		 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) >= p.used_reward
				 				 THEN p.used_reward
				 				 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) < p.used_reward ]]>
				 				 THEN ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}))
	 				  	    </foreach>
				 			END,
			 			 r.balance = 
			 			 	CASE 
			 			 	<foreach collection="list" item="item" >
		 			 			 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) >= p.used_reward
				                 THEN m.total_rewards + p.used_reward
				                 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) < p.used_reward ]]>
				                 THEN m.total_rewards + ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}))
				            </foreach>
				            END,
			 			 p.used_reward =
			 				CASE 
			 				<foreach collection="list" item="item" >
			 				     WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) >= p.used_reward
	                             THEN 0
	                             WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity})) < p.used_reward ]]>
	                             THEN p.used_reward - ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}))
	                        </foreach>
	                        END,
                         m.total_rewards = m.total_rewards + p.used_reward,
                         m.accumulated_use_reward = m.accumulated_use_reward - p.used_points
			WHERE 		 r.reason != '주문취소' AND 
						 p.payment_status = '입금전' AND 
						 p.used_reward > 0 AND 
						 d.product_order_no IN
						 <foreach collection="list" item="item" open="(" close=")" separator=",">
						  	#{item.productOrderNo}
						 </foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 포인트 로그 테이블 update(column : reason, balance, point)) -->
	<update id="updatePendingProductCancelPoint" parameterType="java.util.List">
			UPDATE		 point_logs l
			INNER JOIN	 payments p
			ON 			 l.related_order = p.order_no
			INNER JOIN   detailed_order_items d
			ON			 p.order_no = d.order_no
			INNER JOIN   member m
			ON 			 l.member_id = m.member_id
			INNER JOIN   reward_logs r
			ON			 l.related_order = r.related_order
			SET 	 	 l.reason = '주문취소',
						 l.point = 
							CASE 
							<foreach collection="list" item="item" >
						 		 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) >= p.used_points
				 				 THEN p.used_points
				 				 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) < p.used_points ]]>
				 				 THEN ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward)
	 				  	    </foreach>
				 			END,
			 			 r.balance = 
			 			 	CASE 
			 			 	<foreach collection="list" item="item" >
		 			 			 WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) >= p.used_points
				                 THEN m.total_points + p.used_points
				                 WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) < p.used_points ]]>
				                 THEN m.total_points + ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward)
				            </foreach>
				            END,
			 			 p.used_points =
			 				CASE 
			 				<foreach collection="list" item="item" >
			 				     WHEN ((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) >= p.used_points
	                             THEN 0
	                             WHEN <![CDATA[((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward) < p.used_points ]]>
	                             THEN p.used_points - ROUND((d.product_price * #{item.quantity}) - (d.coupon_discount / d.product_quantity * #{item.quantity}) - r.reward)
	                        </foreach>
	                        END,
                         m.total_points = m.total_points + p.used_points,
                         m.accumulated_use_point = m.accumulated_use_point - p.used_points
			WHERE 		 l.reason != '주문취소' AND 
						 r.reason = '주문취소' AND
						 p.payment_status = '입금전' AND 
						 p.used_points > 0 AND 
						 d.product_order_no IN
						 <foreach collection="list" item="item" open="(" close=")" separator=",">
						  	#{item.productOrderNo}
						 </foreach>
	</update>
	
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 주문 상세 상품 테이블 update(column : product_status, coupon_discount)) -->
	<update id="updatePendingProductCancel" parameterType="java.util.List">
	        UPDATE  detailed_order_items 
	        SET 	product_status = '주문취소', coupon_discount = 0
	        WHERE   product_status = '입금전' AND product_order_no IN
			        <foreach collection="list" item="productOrderNo" open="(" close=")" separator=",">
		        		#{productOrderNo}
		    		</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 주문 내역 테이블 update(column : delivery_status)) -->
	<update id="updatePendingProductCancelHistory" parameterType="java.util.List">
			UPDATE 		order_history h
			LEFT JOIN 	(
							SELECT  count(detailed_order_id) count, order_no
							FROM    detailed_order_items 
							WHERE   product_status = '입금전' AND order_no IN 
									<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
										#{orderNo} 
									</foreach>
						) d
			ON 			h.order_no = d.order_no
			SET    		h.delivery_status = if(COALESCE(d.count, 0) = 0 ,'주문취소', '부분취소') 
			WHERE  		h.order_no IN 
						<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
							#{orderNo}
						</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 쿠폰 로그 테이블 update(돌려줄 쿠폰(count:0) select) -->
	<resultMap id="pendingCouponsResultMap" type="CheckedCoupons">
	    <id column="related_order" property="orderNo"/>
	    <collection property="coupons" resultMap="pendingCouponCountResultMap"/>
	</resultMap>
	
	<resultMap id="pendingCouponCountResultMap" type="CouponCount">
	    <result column="coupon_number" property="couponNumber"/>
	    <result column="count" property="count"/>
	</resultMap>
	
	<select id="selectPendingProductCancelCoupon" parameterType="java.util.List" resultMap="pendingCouponsResultMap">
		<foreach collection="list" item="orderNo" separator="UNION">
	        SELECT		log.coupon_number,
			            COALESCE(ssq.count, 0) count,
			            log.related_order
			FROM		coupon_logs log
			LEFT JOIN (
			                SELECT		cc.coupon_number,
										count(cc.coupon_number) count
			                FROM		coupon_categories cc
			                INNER JOIN (
											SELECT		d.order_no,
														d.product_order_no,
														p.category_key
											FROM		detailed_order_items d
											INNER JOIN 	products p 
			                                ON 			d.product_id = p.product_id
											WHERE		d.product_status = '입금전' AND d.order_no = #{orderNo}
										) s 
							ON 			s.category_key = cc.category_key
			                INNER JOIN (
											SELECT		coupon_number
											FROM		coupon_logs
											WHERE		used_date IS NOT NULL AND related_order = #{orderNo}
											GROUP BY	coupon_number
										) sq 
							ON 			cc.coupon_number = sq.coupon_number
			                WHERE		cc.category_key = s.category_key
			                GROUP BY	cc.coupon_number
			            ) ssq 
			ON 			log.coupon_number = ssq.coupon_number
			WHERE		log.related_order = #{orderNo}
			GROUP BY	coupon_number
    	</foreach>
	</select>
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 쿠폰 로그 테이블 update(column : used_date, related_order)) -->
	<update id="updatePendingProductCancelCoupon" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";">
	        UPDATE  coupon_logs
	        SET 	used_date = NULL, related_order = NULL
	        WHERE   related_order = #{item.orderNo}
			        AND (
				            <foreach collection="item.coupons" item="coupon" index="couponIndex" separator=" OR ">
				                (coupon_number = #{coupon.couponNumber} AND #{coupon.count} = 0)
				            </foreach>
			        	)
	    </foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 회원 테이블 update(column : coupon_count, total_points, 
	  							total_rewards, accumulated_use_reward,accumulated_use_point)) -->
	<update id="updatePendingProductCancelMember" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";">
			UPDATE		 member m
			INNER JOIN	 order_history o
			ON  		 m.member_id = o.member_id
			SET 		 m.coupon_count = m.coupon_count + #{item.couponCount}
			WHERE 		 o.order_no = #{item.orderNo}
		</foreach>
	</update>	
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 결제 테이블 update(column : payment_status)) -->
	<update id="updatePendingProductCancelPayments" parameterType="java.util.List"> 
			UPDATE 		payments p
			INNER JOIN  order_history o
			ON 			p.order_no = o.order_no
			INNER JOIN 	detailed_order_items d
			ON 			p.order_no = d.order_no
			SET 		p.payment_status = o.delivery_status,
						p.total_amount = 
						<foreach collection="list" item="item">
							p.total_amount - (d.product_price * #{item.quantity})	
						</foreach>,	
						p.shipping_fee = 
							CASE 
							<foreach collection="list" item="item">
								 WHEN p.total_amount >= 10000
	                             THEN 0
	                             WHEN <![CDATA[p.total_amount < 10000]]>
	                             THEN 3000
							</foreach>	
	                        END					
			WHERE 		d.product_order_no IN
						<foreach collection="list" item="item" open="(" close=")" separator=",">
				        	#{item.productOrderNo}
				    	</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[품목주문별] - 취소용 추가 정보 조회) -->
	<select id="selectPendingProductCancelInfo" resultType="PendingCancelInfoResponse">
		SELECT  detailed_order_id, product_id, product_order_no 
		FROM    detailed_order_items
		WHERE   product_status = '주문취소' AND order_no IN
				<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
		        	#{orderNo}
		    	</foreach>
	</select>
	
<!-- 입금전 주문취소 주문번호별 -->
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 적립금 로그 테이블 update(column : reason, balance, reward)) -->
	<update id="updatePendingOrderCancelReward" parameterType="java.util.List">			
			UPDATE		 reward_logs r
			INNER JOIN	 payments p
			ON 			 r.related_order = p.order_no
			INNER JOIN   member m
			ON 			 r.member_id = m.member_id
			SET 		 r.reason = '주문취소', 
						 r.reward = p.used_reward,
			             r.balance = total_rewards + p.used_reward
			WHERE 		 r.reason != '주문취소' AND  
						 p.payment_status = '입금전' AND 
						 r.related_order IN
						<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
						 	#{orderNo} 
						</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 포인트 로그 테이블 update(column : reason, balance, point)) -->
	<update id="updatePendingOrderCancelPoint" parameterType="java.util.List">
			UPDATE		 point_logs l
			INNER JOIN	 payments p
			ON 			 l.related_order = p.order_no
			INNER JOIN   member m
			ON 			 l.member_id = m.member_id
			SET 		 l.reason = '주문취소', 
						 l.point = p.used_points,
			             l.balance = m.total_points + p.used_points
			WHERE 		 l.reason != '주문취소' AND 
						 p.payment_status = '입금전' AND 
						 l.related_order IN 
						<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
							#{orderNo}
						</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 주문 상세 상품 테이블 update(column : product_status, coupon_discount)) -->
	<update id="updatePendingOrderCancel" parameterType="java.util.List">
	        UPDATE  detailed_order_items 
	        SET 	product_status = '주문취소', coupon_discount = 0
	        WHERE 	product_status = '입금전' AND order_no IN
			        <foreach collection="list" item="orderNo" open="(" close=")" separator=",">
		        		#{orderNo}
		    		</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 주문 내역 테이블 update(column : delivery_status)) -->
	<update id="updatePendingOrderCancelHistory" parameterType="java.util.List">
			UPDATE order_history
			SET    delivery_status = '주문취소' 
			WHERE  delivery_status = '입금전' AND order_no IN
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
			        	#{orderNo}
			    	</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 쿠폰 로그 테이블 update(column : used_date, related_order)) -->
	<update id="updatePendingOrderCancelCoupon" parameterType="java.util.List">
			UPDATE  coupon_logs
			SET     used_date = NULL,related_order = NULL
			WHERE   related_order IN
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
			        	#{orderNo}
			    	</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 회원 테이블 update(column : coupon_count, total_points, 
	 							total_rewards, accumulated_use_reward,accumulated_use_point)) -->
	<update id="updatePendingOrderCancelMember" parameterType="java.util.List">
		<foreach collection="list" item="orderNo" separator=";">
			UPDATE		 member m
			INNER JOIN	 order_history o
			ON  		 m.member_id = o.member_id
			INNER JOIN	 payments p
			ON 			 o.order_no = p.order_no
			LEFT JOIN    (
							SELECT COUNT(detailed_order_id) count, order_no
						  	FROM   detailed_order_items
						  	WHERE  order_no = #{orderNo} AND 
								   (coupon_discount is not null AND coupon_discount != 0)
					     ) s
			ON           o.order_no = s.order_no
			SET 		 m.coupon_count = m.coupon_count + COALESCE(s.count, 0),
						 m.total_points = m.total_points + p.used_points,
			             m.total_rewards = m.total_rewards + p.used_reward,
			             m.accumulated_use_reward = m.accumulated_use_reward - p.used_points,
			             m.accumulated_use_point = m.accumulated_use_point - p.used_reward
			WHERE 		 o.order_no = #{orderNo}
		</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 결제 테이블 update(column : payment_status)) -->
	<update id="updatePendingOrderCancelPayments" parameterType="java.util.List">
			UPDATE  payments
			SET     payment_status = '주문취소', 
				    used_points = 0,
				    used_reward = 0,
				    total_amount = 0,
				    shipping_fee = 0
			WHERE   payment_status = '입금전' AND order_no IN
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
			        	#{orderNo}
			    	</foreach>
	</update>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별] - 취소용 추가 정보 조회) -->
	<select id="selectPendingCancelInfo" resultType="PendingCancelInfoResponse">
		SELECT  detailed_order_id, product_id, product_order_no 
		FROM    detailed_order_items
		WHERE   product_status = '주문취소' AND order_no IN
				<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
		        	#{orderNo}
		    	</foreach>
	</select>
	
	<!-- 입금 전 관리 (주문 취소 버튼[주문번호별, 품목주문별] - 취소 테이블에 추가) -->
	<insert id="insertPendingOrderCancel" parameterType="java.util.List">			
			INSERT INTO cancellations(product_id, reason, amount, processing_status, 
									  refund_status, request_time, completion_time, detailed_order_id) 
            VALUES	
           	<foreach collection="list" item="item" separator=",">
            (		
            	#{item.productId}, 
            	'입금전 취소[관리자]', 
            	(SELECT (product_price * product_quantity) amount FROM detailed_order_items WHERE product_order_no = #{item.productOrderNo}), 
            	'취소완료',
            	'Y',
            	NOW(),
            	NOW(),
            	#{item.detailedOrderId}
            )	
			</foreach>
	</insert>
	
	<!-- 결제완료 상태로 변경 -->
	<update id="updatePreShipped" parameterType="java.util.List">
			UPDATE 		order_history h 
			INNER JOIN  payments p
			ON 			h.order_no = p.order_no
			INNER JOIN  detailed_order_items d
			ON 			h.order_no = d.order_no
			SET 		h.delivery_status = 
							CASE WHEN h.delivery_status = '입금전' or h.delivery_status = '출고완료'
								 THEN '결제완료' 
								 ELSE h.delivery_status 
							END,
						d.product_status = 
							CASE WHEN d.product_status = '입금전' or d.product_status = '출고완료'
								 THEN '결제완료' 
								 ELSE d.product_status 
							END,
			            p.payment_status = 
		            		CASE WHEN p.payment_status = '입금전' or p.payment_status = '출고완료'
		            			 THEN '결제완료' 
		            			 ELSE p.payment_status
	            			END
			WHERE		d.order_no IN 
						<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
							#{orderNo}
						</foreach>
	</update>
	
	<!-- 입금 전 관리 (입금 확인 버튼 - 입금 확인 날짜 입력) -->
	<update id="updatePreShippedDate">
			UPDATE  bank_transfers
			SET     confirm_date = NOW()
			WHERE   order_no IN
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
						 #{orderNo}
					</foreach>
	</update>
	
	<!-- 입금전 관리 (조회) -->
	<select id="selectPendingProductInfo" resultType="PendingProductResponse">
		SELECT 	 	h.order_time,
					p.order_no,
		         	d.product_order_no,
		         	m.name,
		         	h.member_id,
		        	 pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	d.product_price,
		         	b.deposit_amount,
                 	b.bank_name,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		<where> 
			p.payment_method = 'bkt' 
				AND (b.deposit_amount = 0 OR b.deposit_amount is null)
				AND h.delivery_status = '입금전'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND pr.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND pr.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(confirmDateStart != null and !confirmDateStart.equals("")) and 
	         		(confirmDateEnd != null and !confirmDateEnd.equals(""))'>
	         		AND confirm_date BETWEEN #{confirmDateStart} AND #{confirmDateEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 입금 전 관리 (조회[주문번호별]) -->
	<select id="selectPendingNoInfo" resultType="PendingNoResponse">
		SELECT 	 	h.order_time,
			     	h.order_no,
		CASE   WHEN product_count.count = 1  THEN product_count.product_name
			   ELSE CONCAT(product_count.product_name, ' 외 ', product_count.count - 1, '건')
		        END product_name,  
		         	m.name,
		         	h.member_id,
                 	b.payer_name,
                 	b.deposit_amount,
                 	b.bank_name,
                	if(b.deposit_amount != 0 AND b.deposit_amount is not null, '결제완료', '입금전') status,
		         	h.delivery_message
  		FROM 	    payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		LEFT JOIN   (
						SELECT  	d.order_no, p.product_name, p.category_key, count(distinct d.product_id) count
						FROM 		detailed_order_items d
						INNER JOIN  products p
						ON 			d.product_id = p.product_id
						GROUP BY 	d.order_no
		            ) product_count
		ON 			h.order_no = product_count.order_no
		<where> 
			p.payment_method = 'bkt' 
				AND (b.deposit_amount = 0 OR b.deposit_amount is null)
				AND h.delivery_status = '입금전'
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND product_count.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND product_count.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !dorderTimeEnd.equals(""))'>
	         		AND order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(confirmDateStart != null and !confirmDateStart.equals("")) and 
	         		(confirmDateEnd != null and !confirmDateEnd.equals(""))'>
	         		AND confirm_date BETWEEN #{confirmDateStart} AND #{confirmDateEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC
	</select>
	
	<!-- 입금전 상태로 변경 -->
	<update id="updatePendingPayment">
		UPDATE 		order_history h 
		INNER JOIN  payments p
		ON 			h.order_no = p.order_no
		INNER JOIN  detailed_order_items d
		ON 			h.order_no = d.order_no
		SET 		h.delivery_status = 
						CASE WHEN h.delivery_status = '결제완료'
							 THEN '입금전' 
							 ELSE h.delivery_status 
						END,
					d.product_status = 
						CASE WHEN d.product_status = '결제완료'
							 THEN '입금전' 
							 ELSE d.product_status 
						END,
		            p.payment_status = 
	            		CASE WHEN p.payment_status = '결제완료'
	            			 THEN '입금전' 
	            			 ELSE p.payment_status 
            			END
		WHERE		d.order_no IN 
					<foreach collection="list" item="orderNo" open="(" close=")" separator=",">
						#{orderNo}
					</foreach>
	</update>	
	
	<!-- 전체 주문 조회 (품목주문별) -->
	<select id="selectOrderProductInfo" resultType="OrderProductResponse">
		SELECT 	 	h.order_time,
				 	p.payment_time,
				 	p.order_no,
		        	d.product_order_no,
		         	m.name,
		         	h.member_id,
		         	pr.product_name,
		         	pr.product_id,
		         	d.product_quantity,
		         	d.product_price,
		        	p.actual_payment_amount,
		         	p.payment_method,
		         	p.payment_status,
		         	d.product_status,
		         	d.product_invoice_number,
		         	h.delivery_message
		FROM 		payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		INNER JOIN  detailed_order_items d
		ON 			p.order_no = d.order_no
		INNER JOIN  products pr
		ON 			d.product_id = pr.product_id
		<where> 
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND product_count.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND product_count.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC, d.product_order_no DESC
	</select>
	
	<!-- 전체 주문 조회 (주문번호별) -->
	<select id="selectOrderNoInfo" resultType="OrderNoResponse">
		SELECT 	 	h.order_time,
				 	p.payment_time,
			     	h.order_no,
		         	m.name,
		         	h.member_id,
		CASE   WHEN product_count.count = 1 THEN product_count.product_name
			   ELSE CONCAT(product_count.product_name, ' 외 ', product_count.count - 1, '건')
		       END  product_name,  
			     	p.total_amount,
		         	p.actual_payment_amount,
			     	p.payment_method,
			     	p.payment_status,
		         	status.undelivered,
		         	status.inTransit,
		         	status.delivered,
		         	status.cancels,
		         	status.exchanges,
		         	status.returns,
		         	h.delivery_message
  		FROM 	 	payments p
		INNER JOIN  order_history h 
		ON 			p.order_no = h.order_no
		INNER JOIN  member m 
		ON 			h.member_id = m.member_id 
		LEFT JOIN   bank_transfers b 
		ON 			p.payment_number = b.payment_number
		LEFT JOIN 	(
						SELECT   d.order_no,
							     (SELECT count(*) FROM detailed_order_items 
							      WHERE  product_status in ('입금완료', '결제완료', '출고완료', '주문취소') 
							      and    order_no = d.order_no) 'Undelivered',
							     (SELECT count(*) FROM detailed_order_items 
							      WHERE  product_status = '배송중' 
							      and    order_no = d.order_no) 'intransit',
							     (SELECT count(*) FROM detailed_order_items 
							      WHERE  product_status in ('배송완료','반품','교환') 
							      and    order_no = d.order_no) 'Delivered',
							     (SELECT count(*) FROM detailed_order_items 
							      WHERE  product_status = '주문취소' 
							      and    order_no = d.order_no) 'cancels',
							     (SELECT count(*) FROM detailed_order_items 
							      WHERE  product_status = '교환' 
							      and    order_no = d.order_no) 'exchanges',
							     (SELECT count(*) FROM detailed_order_items 
							      WHERE  product_status = '반품' 
							      and    order_no = d.order_no) 'returns'
					    FROM 	 detailed_order_items d
						GROUP BY d.order_no 
					) status
		ON 			h.order_no = status.order_no
		LEFT JOIN   (
						SELECT  	d.order_no, 
									p.product_name, 
									p.category_key, 
									count(distinct d.product_id) count
						FROM 		detailed_order_items d
						INNER JOIN  products p
						ON 			d.product_id = p.product_id
						GROUP BY 	d.order_no
					) product_count
		ON 			h.order_no = product_count.order_no
		<where> 
			<if test='orderNo != null and !orderNo.equals("")' >
				AND h.order_no = #{orderNo}
			</if>
			<if test='productOrderNo != null and !productOrderNo.equals("")' >
				AND d.product_order_no = #{productOrderNo}
			</if>
			<if test='invoiceNumber != null and !invoiceNumber.equals("")' >
				AND h.invoice_number = #{invoiceNumber}
			</if>
			<if test='name != null and !name.equals("")' >
				AND m.name = #{name}
			</if>
			<if test='memberId != null and !memberId.equals("")' >
				AND h.member_id = #{memberId}
			</if>
			<if test='email != null and !email.equals("")' >
				AND m.email = #{email}
			</if>
			<if test='cellPhoneNumber != null and !cellPhoneNumber.equals("")' >
				AND m.cell_phone_number = #{cellPhoneNumber}
			</if>
			<if test='phoneNumber != null and !phoneNumber.equals("")' >
				AND m.phone_number = #{phoneNumber}
			</if>
			<if test='payerName != null and !payerName.equals("")' >
				AND b.payer_name = #{payerName}
			</if>
			<if test='recipientName != null and !recipientName.equals("")' >
				AND h.recipient_name = #{recipientName}
			</if>
			<if test='recipientPhoneNumber != null and !recipientPhoneNumber.equals("")' >
				AND h.recipient_phone_number = #{recipientPhoneNumber}
			</if>
			<if test='shippingAddress != null and !shippingAddress.equals("")' >
				AND h.shipping_address = #{shippingAddress}
			</if>
			<if test='productName != null and !productName.equals("")' >
				AND product_count.product_name like CONCAT('%',#{productName},'%')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     NCAT('%',#{productName},'%') 
			</if>
			<if test='productId != null and !productId.equals("")' >
				AND d.product_id = #{productId}
			</if>
			<if test='categoryKey != null and !categoryKey.equals("")' >
				AND product_count.category_key = #{categoryKey}
			</if>
			<if test='(orderTimeStart != null and !orderTimeStart.equals("")) and 
	         		(orderTimeEnd != null and !orderTimeEnd.equals(""))'>
	         		AND h.order_time BETWEEN #{orderTimeStart} AND #{orderTimeEnd}
         	</if>
         	<if test='(paymentTimeStart != null and !paymentTimeStart.equals("")) and 
	         		(paymentTimeEnd != null and !paymentTimeEnd.equals(""))'>
	         		AND p.payment_time BETWEEN #{paymentTimeStart} AND #{paymentTimeEnd}
         	</if>
		</where>
		ORDER BY h.order_time DESC
	</select> 
</mapper>