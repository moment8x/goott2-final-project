<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.mappers.reviewMapper">
	<insert id="insertReview">
		INSERT INTO review_board(author, content, ref, rating, product_id) VALUES(#{author}, #{content}, #{ref}, #{rating}, #{productId})
	</insert>
	<select id="getReviewNo" resultType="Integer">
		SELECT post_no FROM review_board WHERE author = #{author} limit 1
	</select>
	<select id="getPruchaseRecord" resultType="String">
		SELECT o.order_no
		FROM order_history o
		INNER JOIN detailed_order_items d
		ON o.order_no = d.order_no
		WHERE member_id = '${memberId}'
			AND delivery_status='배송완료'
			AND product_id='${productId}'
		GROUP BY o.order_no
	</select>
	<select id="isExists" resultType="String">
		SELECT post_no FROM review_board WHERE author='#{memberId}' AND product_id='#{productId}'
	</select>
	<select id="getPointRule" resultType="Integer">
		SELECT point FROM point_rules WHERE reason=#{reason}
	</select>
	<insert id="insertPointLog">
		<selectKey keyProperty="balance" resultType="int" order="BEFORE">
			SELECT total_points + #{point} FROM member WHERE member_id = #{memberId}
		</selectKey>
		INSERT INTO point_logs(member_id, reason, point, balance) VALUES(#{memberId}, '리뷰작성', #{point}, #{balance})
	</insert>
	<update id="updatePoint">
		UPDATE member SET total_points = total_points + #{point}, accumulated_point = accumulated_point + {point}
		WHERE member_id = #{memberId}
	</update>
</mapper>