<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ksh.mappers.OrderMapper">
	<insert id="insertNewPayment">
	<choose>
	<when test="nonOrderNo != null">
		INSERT INTO payments (payment_number, non_order_no,
		payment_method, total_amount, shipping_fee, used_points, used_reward,
		actual_payment_amount, payment_time, card_name, card_number, payment_status)
		VALUES(#{paymentNumber}, #{nonOrderNo}, #{paymentMethod},
		#{totalAmount}, #{shippingFee},
		#{usedPoints}, #{usedReward},
		#{actualPaymentAmount},
		#{paymentTime},#{cardName},#{cardNumber}, #{paymentStatus})
	</when>
	<otherwise>
	INSERT INTO payments (payment_number, order_no,
		payment_method, total_amount, shipping_fee, used_points, used_reward,
		actual_payment_amount, payment_time, card_name, card_number, payment_status)
		VALUES(#{paymentNumber}, #{orderNo}, #{paymentMethod},
		#{totalAmount}, #{shippingFee},
		#{usedPoints}, #{usedReward},
		#{actualPaymentAmount},
		#{paymentTime},#{cardName},#{cardNumber}, #{paymentStatus})
	</otherwise>
	</choose>
	</insert>

	<insert id="insertDetailOrderItem" parameterType="java.util.Map">
		<choose>
		<when test="nonOrderNo != null">
		INSERT INTO detailed_order_items
		(non_order_no, product_id,
		product_price, product_quantity, product_status, product_order_no)
		VALUES
		<foreach item="item" index="index" collection="list"
			separator=",">
			(#{item.nonOrderNo}, #{item.productId},
			#{item.productPrice},#{item.productQuantity},#{item.productStatus},#{item.productOrderNo})
		</foreach>
		</when>
		<otherwise>
		INSERT INTO detailed_order_items
		(order_no, product_id,
		product_price, product_quantity, product_status, product_order_no)
		VALUES
		<foreach item="item" index="index" collection="list"
			separator=",">
			(#{item.orderNo}, #{item.productId},
			#{item.productPrice},#{item.productQuantity},#{item.productStatus},#{item.productOrderNo})
		</foreach>
		</otherwise>
		</choose>
		
	</insert>

	<insert id="insertNewNonOrderHistory">
		INSERT INTO non_order_history (non_order_no,
		non_member_id, non_recipient_name, non_recipient_phone_number,
		non_zip_code,
		non_shipping_address, non_detailed_shipping_adress,
		non_delivery_message,
		non_password, non_email, non_delivery_status)
		VALUES(#{nonOrderNo},
		#{nonMemberId}, #{recipientName},
		#{recipientPhoneNumber},
		#{zipCode}, #{shippingAddress},
		#{detailedShippingAddress},
		#{deliveryMessage}, #{nonPassword},
		#{nonEmail},
		#{deliveryStatus})
	</insert>
	
	<insert id="insertNewOrderHistory">
		INSERT INTO order_history (order_no,
		member_id, recipient_name, recipient_phone_number,
		zip_code,
		shipping_address, detailed_shipping_address,
		delivery_message,
		delivery_status)
		VALUES(#{orderNo},
		#{memberId}, #{recipientName},
		#{recipientPhoneNumber},
		#{zipCode}, #{shippingAddress},
		#{detailedShippingAddress},
		#{deliveryMessage},
		#{deliveryStatus})
	</insert>

	<select id="getPaymentDetail" resultType="com.project.vodto.CompleteOrder">
		select order_no, payment_method, card_name,
		total_amount,
		actual_payment_amount from
		payments where order_no = #{orderNo};
	</select>



	<resultMap id="result" type="com.project.vodto.OrderInfo">

		<result property="productId" column="product_id" />
		<result property="productName" column="product_name" />
		<result property="productImage" column="product_image" />
		<result property="categoryKey" column="category_key" />
		<result property="currentQuantity" column="current_quantity" />
		<result property="sellingPrice" column="selling_price" />

	</resultMap>

	<select id="getProductInfo"
		parameterType="com.project.vodto.OrderInfo" resultMap="result">
		select p.product_id, p.product_name, i.product_image, p.category_key,
		p.current_quantity,
		p.selling_price from products p inner join product_images i on
		p.product_id = i.product_id where p.product_id = #{productId} limit
		1;
	</select>

	<insert id="saveBankTransfer">
	<choose>
	<when test="nonOrderNo != null">
		INSERT INTO bank_transfers (non_order_no,
		payment_number, payer_name, amount_to_pay)
		VALUES(#{nonOrderNo},
		#{paymentNumber}, #{recipientName}, #{amountToPay})
		</when>
		<otherwise>
		INSERT INTO bank_transfers (order_no,
		payment_number, payer_name, amount_to_pay)
		VALUES(#{orderNo},
		#{paymentNumber}, #{recipientName}, #{amountToPay})
		</otherwise>
	</choose>
	</insert>

	<select id="getShippingAddr"
		resultType="com.project.vodto.ShippingAddress">
		select * from shipping_address where member_id =
		#{memberId}
	</select>

	<select id="getCouponInfos"
		resultType="com.project.vodto.CouponInfos">
		select l.member_id, l.coupon_number, l.obtained_date, l.used_date,
		l.expiration_date, c.coupon_name, c.discount_method, c.
		discount_amount
		from coupon_logs l inner join coupons c on l.coupon_number =
		c.coupon_number where member_id = #{memberId};
	</select>
	
	<select id="getCategoryKey" resultType="String">
	select category_key from coupon_categories where coupon_number = #{couponNumber};
	</select>
	<select id="getDetailOrderItem" resultType="com.project.vodto.DetailOrderItem">
		
	</select>

</mapper>